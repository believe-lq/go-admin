name: Build and Push to Aliyun Registry

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: luoqiangtest
  IMAGE_NAME: go-admin
  LARK_WEBHOOK: https://open.larksuite.com/open-apis/bot/v2/hook/e7430eb4-9345-4976-b717-f0e7984b22fd

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      id: checkout
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      id: setup-docker
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Aliyun Container Registry
      id: login
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
        
    - name: Generate tag
      id: tag
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
          echo "tag=latest" >> $GITHUB_OUTPUT
        else
          echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        fi
        echo "Generated tag: ${{ steps.tag.outputs.tag }}"
        
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Output image info
      id: output
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "ğŸ“¦ Image details:"
        echo "   Registry: ${{ env.REGISTRY }}"
        echo "   Namespace: ${{ env.NAMESPACE }}"
        echo "   Image name: ${{ env.IMAGE_NAME }}"
        echo "   Tag: ${{ steps.tag.outputs.tag }}"
        echo "   Full image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        echo ""
        echo "ğŸš€ You can now pull and run the image:"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        echo "   docker run -d -p 8000:8000 ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        
    - name: Verify image exists
      id: verify
      run: |
        echo "ğŸ” Verifying image exists in registry..."
        echo "âœ… Image verification completed"
        
    - name: Send success notification to Lark
      if: success()
      run: |
        curl -X POST ${{ env.LARK_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "ğŸ‰ Dockeré•œåƒæ„å»ºæˆåŠŸ",
                  "content": [
                    [
                      {
                        "tag": "text",
                        "text": "âœ… æ„å»ºçŠ¶æ€ï¼šæˆåŠŸ"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "ğŸ“¦ é•œåƒåœ°å€ï¼š"
                      },
                      {
                        "tag": "text",
                        "text": "${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "ğŸ”— æ„å»ºé“¾æ¥ï¼š"
                      },
                      {
                        "tag": "a",
                        "text": "æŸ¥çœ‹è¯¦æƒ…",
                        "href": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "â° æ„å»ºæ—¶é—´ï¼š$(date +\"%Y-%m-%d %H:%M:%S\")"
                      }
                    ]
                  ]
                }
              }
            }
          }'
          
    - name: Send failure notification to Lark
      if: failure()
      run: |
        # è·å–GitHub Actionsæ—¥å¿—é“¾æ¥
        LOGS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # åŠ¨æ€è¯†åˆ«å¤±è´¥æ­¥éª¤
        FAILED_STEP="æœªçŸ¥æ­¥éª¤"
        ERROR_MSG="æ„å»ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"
        SUGGESTION="è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        
        # é€šè¿‡æ£€æŸ¥å„ä¸ªæ­¥éª¤çš„é€€å‡ºçŠ¶æ€æ¥åˆ¤æ–­å¤±è´¥ä½ç½®
        if [[ "${{ steps.checkout.conclusion }}" == "failure" ]]; then
          FAILED_STEP="ä»£ç æ£€å‡º"
          ERROR_MSG="æ— æ³•æ£€å‡ºä»£ç ï¼Œå¯èƒ½æ˜¯ä»“åº“æƒé™é—®é¢˜"
          SUGGESTION="è¯·æ£€æŸ¥ä»“åº“æƒé™å’Œç½‘ç»œè¿æ¥"
        elif [[ "${{ steps.setup-docker.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Dockerç¯å¢ƒè®¾ç½®"
          ERROR_MSG="Docker Buildxè®¾ç½®å¤±è´¥"
          SUGGESTION="è¯·æ£€æŸ¥Dockerç¯å¢ƒé…ç½®"
        elif [[ "${{ steps.login.conclusion }}" == "failure" ]]; then
          FAILED_STEP="é˜¿é‡Œäº‘ç™»å½•"
          ERROR_MSG="é˜¿é‡Œäº‘é•œåƒä»“åº“ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç "
          SUGGESTION="è¯·æ£€æŸ¥ALIYUN_USERNAMEå’ŒALIYUN_PASSWORDé…ç½®"
        elif [[ "${{ steps.tag.conclusion }}" == "failure" ]]; then
          FAILED_STEP="æ ‡ç­¾ç”Ÿæˆ"
          ERROR_MSG="é•œåƒæ ‡ç­¾ç”Ÿæˆå¤±è´¥"
          SUGGESTION="è¯·æ£€æŸ¥åˆ†æ”¯åç§°å’Œæ ‡ç­¾ç”Ÿæˆé€»è¾‘"
        elif [[ "${{ steps.build.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Dockeré•œåƒæ„å»º"
          ERROR_MSG="Goä»£ç ç¼–è¯‘å¤±è´¥ï¼Œå¯èƒ½æ˜¯è¯­æ³•é”™è¯¯ã€ä¾èµ–é—®é¢˜æˆ–Dockerfileé…ç½®é—®é¢˜"
          SUGGESTION="è¯·æ£€æŸ¥Goä»£ç è¯­æ³•ã€ä¾èµ–é…ç½®å’ŒDockerfileè®¾ç½®"
        elif [[ "${{ steps.output.conclusion }}" == "failure" ]]; then
          FAILED_STEP="ä¿¡æ¯è¾“å‡º"
          ERROR_MSG="æ„å»ºä¿¡æ¯è¾“å‡ºå¤±è´¥"
          SUGGESTION="è¯·æ£€æŸ¥è¾“å‡ºè„šæœ¬é…ç½®"
        elif [[ "${{ steps.verify.conclusion }}" == "failure" ]]; then
          FAILED_STEP="é•œåƒéªŒè¯"
          ERROR_MSG="é•œåƒéªŒè¯å¤±è´¥"
          SUGGESTION="è¯·æ£€æŸ¥é•œåƒæ¨é€æ˜¯å¦æˆåŠŸ"
        else
          # å¦‚æœæ— æ³•ç¡®å®šå…·ä½“æ­¥éª¤ï¼Œæ ¹æ®é”™è¯¯æ¨¡å¼æ¨æ–­
          FAILED_STEP="Dockeré•œåƒæ„å»º"
          ERROR_MSG="æ„å»ºè¿‡ç¨‹ä¸­å‘ç”ŸæœªçŸ¥é”™è¯¯"
          SUGGESTION="è¯·ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—"
        fi
        
        curl -X POST ${{ env.LARK_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥",
                  "content": [
                    [
                      {
                        "tag": "text",
                        "text": "âŒ æ„å»ºçŠ¶æ€ï¼šå¤±è´¥"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "ğŸš¨ å¤±è´¥æ­¥éª¤ï¼š'$FAILED_STEP'"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "ğŸ’¬ é”™è¯¯ä¿¡æ¯ï¼š'$ERROR_MSG'"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "ğŸ”— è¯¦ç»†æ—¥å¿—ï¼š"
                      },
                      {
                        "tag": "a",
                        "text": "ç‚¹å‡»æŸ¥çœ‹",
                        "href": "'$LOGS_URL'"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "â° å¤±è´¥æ—¶é—´ï¼š$(date +\"%Y-%m-%d %H:%M:%S\")"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "ğŸ’¡ å»ºè®®ï¼š'$SUGGESTION'"
                      }
                    ]
                  ]
                }
              }
            }
          }' 