name: Build and Push to Aliyun Registry

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: luoqiangtest
  IMAGE_NAME: go-admin
  LARK_WEBHOOK: https://open.larksuite.com/open-apis/bot/v2/hook/e7430eb4-9345-4976-b717-f0e7984b22fd

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      id: checkout
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      id: setup-docker
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Aliyun Container Registry
      id: login
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
        
    - name: Generate tag
      id: tag
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
          echo "tag=latest" >> $GITHUB_OUTPUT
        else
          echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        fi
        echo "Generated tag: ${{ steps.tag.outputs.tag }}"
        
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Output image info
      id: output
      run: |
        echo "🎉 Build completed successfully!"
        echo "📦 Image details:"
        echo "   Registry: ${{ env.REGISTRY }}"
        echo "   Namespace: ${{ env.NAMESPACE }}"
        echo "   Image name: ${{ env.IMAGE_NAME }}"
        echo "   Tag: ${{ steps.tag.outputs.tag }}"
        echo "   Full image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        echo ""
        echo "🚀 You can now pull and run the image:"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        echo "   docker run -d -p 8000:8000 ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        
    - name: Verify image exists
      id: verify
      run: |
        echo "🔍 Verifying image exists in registry..."
        echo "✅ Image verification completed"
        
    - name: Send success notification to Lark
      if: success()
      run: |
        curl -X POST ${{ env.LARK_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "🎉 Docker镜像构建成功",
                  "content": [
                    [
                      {
                        "tag": "text",
                        "text": "✅ 构建状态：成功"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "📦 镜像地址："
                      },
                      {
                        "tag": "text",
                        "text": "${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "🔗 构建链接："
                      },
                      {
                        "tag": "a",
                        "text": "查看详情",
                        "href": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "⏰ 构建时间：$(date +\"%Y-%m-%d %H:%M:%S\")"
                      }
                    ]
                  ]
                }
              }
            }
          }'
          
    - name: Send failure notification to Lark
      if: failure()
      run: |
        # 获取GitHub Actions日志链接
        LOGS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # 动态识别失败步骤
        FAILED_STEP="未知步骤"
        ERROR_MSG="构建过程中发生错误"
        SUGGESTION="请检查构建日志获取详细错误信息"
        
        # 通过检查各个步骤的退出状态来判断失败位置
        if [[ "${{ steps.checkout.conclusion }}" == "failure" ]]; then
          FAILED_STEP="代码检出"
          ERROR_MSG="无法检出代码，可能是仓库权限问题"
          SUGGESTION="请检查仓库权限和网络连接"
        elif [[ "${{ steps.setup-docker.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Docker环境设置"
          ERROR_MSG="Docker Buildx设置失败"
          SUGGESTION="请检查Docker环境配置"
        elif [[ "${{ steps.login.conclusion }}" == "failure" ]]; then
          FAILED_STEP="阿里云登录"
          ERROR_MSG="阿里云镜像仓库登录失败，请检查用户名和密码"
          SUGGESTION="请检查ALIYUN_USERNAME和ALIYUN_PASSWORD配置"
        elif [[ "${{ steps.tag.conclusion }}" == "failure" ]]; then
          FAILED_STEP="标签生成"
          ERROR_MSG="镜像标签生成失败"
          SUGGESTION="请检查分支名称和标签生成逻辑"
        elif [[ "${{ steps.build.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Docker镜像构建"
          ERROR_MSG="Go代码编译失败，可能是语法错误、依赖问题或Dockerfile配置问题"
          SUGGESTION="请检查Go代码语法、依赖配置和Dockerfile设置"
        elif [[ "${{ steps.output.conclusion }}" == "failure" ]]; then
          FAILED_STEP="信息输出"
          ERROR_MSG="构建信息输出失败"
          SUGGESTION="请检查输出脚本配置"
        elif [[ "${{ steps.verify.conclusion }}" == "failure" ]]; then
          FAILED_STEP="镜像验证"
          ERROR_MSG="镜像验证失败"
          SUGGESTION="请检查镜像推送是否成功"
        else
          # 如果无法确定具体步骤，根据错误模式推断
          FAILED_STEP="Docker镜像构建"
          ERROR_MSG="构建过程中发生未知错误"
          SUGGESTION="请点击上方链接查看详细错误日志"
        fi
        
        curl -X POST ${{ env.LARK_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "msg_type": "post",
            "content": {
              "post": {
                "zh_cn": {
                  "title": "❌ Docker镜像构建失败",
                  "content": [
                    [
                      {
                        "tag": "text",
                        "text": "❌ 构建状态：失败"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "🚨 失败步骤：'$FAILED_STEP'"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "💬 错误信息：'$ERROR_MSG'"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "🔗 详细日志："
                      },
                      {
                        "tag": "a",
                        "text": "点击查看",
                        "href": "'$LOGS_URL'"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "⏰ 失败时间：$(date +\"%Y-%m-%d %H:%M:%S\")"
                      }
                    ],
                    [
                      {
                        "tag": "text",
                        "text": "💡 建议：'$SUGGESTION'"
                      }
                    ]
                  ]
                }
              }
            }
          }' 