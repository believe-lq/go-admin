name: Build and Push to Aliyun Registry

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: luoqiangtest
  IMAGE_NAME: go-admin
  LARK_WEBHOOK: https://open.larksuite.com/open-apis/bot/v2/hook/e7430eb4-9345-4976-b717-f0e7984b22fd

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      id: checkout
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      id: setup-docker
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Aliyun Container Registry
      id: login
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
        
    - name: Generate tag
      id: tag
      run: |
        if [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
          echo "tag=latest" >> $GITHUB_OUTPUT
        else
          echo "tag=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        fi
        echo "Generated tag: ${{ steps.tag.outputs.tag }}"
        
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Output image info
      id: output
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "ğŸ“¦ Image details:"
        echo "   Registry: ${{ env.REGISTRY }}"
        echo "   Namespace: ${{ env.NAMESPACE }}"
        echo "   Image name: ${{ env.IMAGE_NAME }}"
        echo "   Tag: ${{ steps.tag.outputs.tag }}"
        echo "   Full image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        echo ""
        echo "ğŸš€ You can now pull and run the image:"
        echo "   docker pull ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        echo "   docker run -d -p 8000:8000 ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
        
    - name: Send success notification to Lark
      if: success()
      run: |
        echo "å‘é€æˆåŠŸé€šçŸ¥åˆ°é£ä¹¦..."
        
        # æ„å»ºæ¶ˆæ¯å†…å®¹
        MESSAGE="Dockeré•œåƒæ„å»ºæˆåŠŸ\n\næ„å»ºçŠ¶æ€ï¼šæˆåŠŸ\né•œåƒåœ°å€ï¼š${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}\næ„å»ºé“¾æ¥ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\næ„å»ºæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
        
        # å‘é€æ–‡æœ¬æ¶ˆæ¯
        curl -X POST ${{ env.LARK_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d "{\"msg_type\": \"text\", \"content\": {\"text\": \"$MESSAGE\"}}" \
          --silent --show-error --fail
        
        if [ $? -eq 0 ]; then
          echo "æˆåŠŸé€šçŸ¥å‘é€å®Œæˆ"
        else
          echo "é€šçŸ¥å‘é€å¤±è´¥ï¼Œä½†ä¸å½±å“æ„å»º"
        fi
        
    - name: Send failure notification to Lark
      if: failure()
      run: |
        echo "å‘é€å¤±è´¥é€šçŸ¥åˆ°é£ä¹¦..."
        
        # è·å–å¤±è´¥æ­¥éª¤ä¿¡æ¯
        FAILED_STEP="æœªçŸ¥æ­¥éª¤"
        
        # æ£€æŸ¥å„ä¸ªæ­¥éª¤çŠ¶æ€
        if [[ "${{ steps.checkout.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Checkout code"
        elif [[ "${{ steps.setup-docker.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Set up Docker Buildx"
        elif [[ "${{ steps.login.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Login to Aliyun Container Registry"
        elif [[ "${{ steps.tag.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Generate tag"
        elif [[ "${{ steps.build.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Build and push Docker image"
        elif [[ "${{ steps.output.conclusion }}" == "failure" ]]; then
          FAILED_STEP="Output image info"
        else
          FAILED_STEP="Build and push Docker image"
        fi
        
        # æ„å»ºå¤±è´¥æ¶ˆæ¯
        MESSAGE="Dockeré•œåƒæ„å»ºå¤±è´¥\n\nå¤±è´¥æ­¥éª¤ï¼š$FAILED_STEP\nå¤±è´¥æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')\nè¯¦ç»†æ—¥å¿—ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # å‘é€å¤±è´¥é€šçŸ¥
        curl -X POST ${{ env.LARK_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d "{\"msg_type\": \"text\", \"content\": {\"text\": \"$MESSAGE\"}}" \
          --silent --show-error --fail
        
        if [ $? -eq 0 ]; then
          echo "å¤±è´¥é€šçŸ¥å‘é€å®Œæˆ"
        else
          echo "é€šçŸ¥å‘é€å¤±è´¥ï¼Œä½†ä¸å½±å“æ„å»ºçŠ¶æ€"
        fi 